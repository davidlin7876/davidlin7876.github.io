---
title: LoopBack学习之命令行
date: 
tags: [NodeJS]
categories: 学习笔记
description: 
top: 
---
### 创建新应用程序:

```
$ lb
```

然后，生成器将显示消息，因为它支架应用程序包括：

1. 初始化  项目文件夹结构。
1. 创建默认的JSON文件。
1. 创建默认的JavaScript文件。
1. 下载并安装依赖节点模块（就好像已经手动完成  npm install）。

### 创建模型:
```
$ lb model
```

- 型号名称：review
- 资料来源：mongoDs（mongodb）
- 基类：使用向下箭头键选择  PersistedModel。
- 通过REST API公开审查？按RETURN接受默认值。
- 自定义复数形式（用于构建REST URL）：按RETURN接受默认值，是。
- 通用型号或服务器：按RETURN接受默认的常用型号。

模型生成器将在应用程序的common/models目录中创建两个定义模型的文件


### 定义关系
现在，您将要定义模型之间的这些关系。总共有五个关系。再次，您将使用该lb命令，但这次您将使用relation子命令（关系生成器）。对于每个关系，请输入：


```
$ lb relation
```
#### 查看模型JSON文件
现在，看看common/models/review.json

```
...
"relations": {
  "coffeeShop": {
    "type": "belongsTo",
    "model": "CoffeeShop",
    "foreignKey": ""
  },
  "reviewer": {
    "type": "belongsTo",
    "model": "Reviewer",
    "foreignKey": "publisherId"
  }
},
...
```

#### 定义访问控制
再次，您将使用该lb工具，但这次您将使用acl子命令; 对于每个ACL，输入：


```
$ lb acl
```
#### 查看review.json文件
完成后，ACL部分  common/models/review.json 应如下所示：


```
... 
"acls": [{
  "accessType": "*",
  "principalType": "ROLE",
  "principalId": "$everyone",
  "permission": "DENY"
}, {
  "accessType": "READ",
  "principalType": "ROLE",
  "principalId": "$everyone",
  "permission": "ALLOW"
}, {
  "accessType": "EXECUTE",
  "principalType": "ROLE",
  "principalId": "$authenticated",
  "permission": "ALLOW",
  "property": "create"
}, {
  "accessType": "WRITE",
  "principalType": "ROLE",
  "principalId": "$owner",
  "permission": "ALLOW"
}],
...
```



### 添加数据源:

```
$ lb datasource
```

### 安装SQLDB连接器

```
$ npm install loopback-connector-mysql --save。
```


### 安装MongoDB连接器

```
$ npm install --save loopback-connector-mongodb
```


该工具还将数据源定义添加到  server/datasources.json 文件中，如下所示。请注意刚刚添加的“mysqlDs”数据源，以及名为“db”的内存数据源，默认情况下是这样。

**/server/datasources.json**

```
{
    "db": {
        "name": "db",
        "connector": "memory"
    },
    "mysqlDs": {
      "host": "demo.strongloop.com",
      "port": 3306,
      "url": "",
      "database": "getting_started",
      "password": "L00pBack",
      "name": "mysqlDs",
      "user": "demo",
      "connector": "mysql"
    }
    ...
    "mongoDs": {
        "name": "mongoDs",
        "connector": "mongodb",
        "host": "demo.strongloop.com",
        "port": 27017,
        "database": "getting_started_intermediate",
        "username": "demo",
        "password": "L00pBack"
    }
}
```

### 将模型连接到数据源
LoopBack应用程序使用  model-config.json  文件将模型链接到数据源。编辑  /server/model-config.json 并查找CoffeeShop条目：

**/server/model-config.json**

```
...
  "CoffeeShop": {
    "dataSource": "db",
    "public": true
  }
  ...
```

将dataSource 属性  更改  db 为  mysqlDs。这将CoffeeShop模型附加到刚刚创建和配置的MySQL数据源：

**/server/model-config.json**

```
...
  "CoffeeShop": {
    "dataSource": "mysqlDs",
    "public": true
  }
  ...
```

### 添加一些测试数据并查看它
现在您在LoopBack中有一个CoffeeShop模型，如何在MySQL数据库中创建相应的表？

您可以直接尝试执行一些SQL语句，但是LoopBack提供了一个Node API，可以自动使用称为自动迁移的过程  。有关详细信息，请参阅  从模型创建数据库模式。

该  loopback-getting-started 模块包含create-sample-models.js 演示自动迁移的  脚本。如果你从一开始就一直在追踪（而不是克隆这个模块），那么你需要从下面或从GitHub复制它   。将其放在应用程序的  /server/boot 目录中，以便在应用程序启动时执行。

>  注意： 下面的自动迁移脚本是在应用程序初始启动时LoopBack执行的引导脚本的示例。使用引导脚本进行初始化，并执行应用程序启动时执行的任何其他逻辑。有关详细信息，请参阅定义启动脚本。

**/server/boot/create-sample-models.js**

```
module.exports = function(app) {
  app.dataSources.mysqlDs.automigrate('CoffeeShop', function(err) {
    if (err) throw err;

    app.models.CoffeeShop.create([{
      name: 'Bel Cafe',
      city: 'Vancouver'
    }, {
      name: 'Three Bees Coffee House',
      city: 'San Mateo'
    }, {
      name: 'Caffe Artigiano',
      city: 'Vancouver'
    }, ], function(err, coffeeShops) {
      if (err) throw err;

      console.log('Models created: \n', coffeeShops);
    });
  });
};
```


### 更新引导脚本以添加数据 
记得早在第一部分的  入门，你  增加了一个启动脚本  来创建模型（通过自动迁移）数据库表和一些数据添加到数据库中。

现在您有了一些新的模型和新的数据源，您需要更新此脚本，以便在MongoDB中创建数据结构，并通过新模型插入数据。

复制和粘贴下面的代码  到  server/boot/create-sample-models.js，替换现有的代码。

然后跑


```
$ npm install --save async
```

此启动脚本有几个功能：

- createCoffeeShops()为CoffeeShop模型创建一个MySQL表，并将数据添加到表中。 这是create-sample-models.js从入门起的脚本 。
- createReviewers() 使用自动迁移在MongoDB中创建Reviewer数据结构，并向其添加数据。  
- createReviews() 在MongoDB中使用自动迁移创建评论数据结构，并向其添加数据。


### 启动应用程序：

```
$ node .
```